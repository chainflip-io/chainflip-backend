# ------------------- anchors ------------------- #
ignore_main_branches: &ignore_main_branches
  filters:
    branches:
      ignore:
        - main
        - develop
        - /epic\/.*/
        - /release\/.*/# ------------------- anchors ------------------- #
only_main_branches: &only_main_branches
  filters:
    branches:
      only:
        - main
        - develop
        - /epic\/.*/
        - /release\/.*/

auth: &dockerconfig
  username: $DOCKER_USERNAME
  password: $DOCKER_PASSWORD

cargo-base-job: &cargo-base-job
  docker:
    - image: ghcr.io/chainflip-io/chainflip-backend/rust-base:latest
      auth: *dockerconfig
  environment:
    SCCACHE_REDIS: redis://167.172.97.176:6379
    SCCACHE_CACHE_SIZE: 14G
  working_directory: /mnt/ramdisk
  resource_class: xlarge

chainflip-docker-base: &chainflip-docker-base
  executor: docker/docker
  working_directory: /mnt/ramdisk
  steps:
    - setup_remote_docker:
        version: 19.03.13
        docker_layer_caching: true
    - checkout
    - attach_workspace:
        at: ./
    - docker/check:
        docker-username: DOCKER_USERNAME
        registry: ghcr.io
    - docker/build:
        image: $IMAGE
        registry: ghcr.io
        extra_build_args: $BUILD_ARGS
    - docker/push:
        registry: ghcr.io
        image: $IMAGE
        tag: $TAG
# ------------------- anchors ------------------- #

version: 2.1
orbs:
  docker: circleci/docker@1.7.0
  discord: antonioned/discord@0.1.0
workflows:
  #  chainflip-backend-checks:
  #    jobs:
  #      - build-rust-base:
  #          context:
  #            - ghcr-credentials
  #          <<: *ignore_main_branches
  #      - fmt-validator-package:
  #          requires:
  #            - build-rust-base
  #          context:
  #            - ghcr-credentials
  #          <<: *ignore_main_branches
  #      - check-validator-package:
  #          requires:
  #            - fmt-validator-package
  #          context:
  #            - ghcr-credentials
  #          <<: *ignore_main_branches
  #      - test-validator-package:
  #          requires:
  #            - check-validator-package
  #          context:
  #            - ghcr-credentials
  #          <<: *ignore_main_branches
  chainflip-backend-release:
    jobs:
      - build-rust-base:
          context:
            - ghcr-credentials
          <<: *ignore_main_branches
      #          <<: *only_main_branches
      - fmt-validator-package:
          requires:
            - build-rust-base
          context:
            - ghcr-credentials
          <<: *ignore_main_branches
      #          <<: *only_main_branches
      - compile-validator-package:
          requires:
            - fmt-validator-package
          context:
            - ghcr-credentials
            - discord-webhooks
          <<: *ignore_main_branches
      #          <<: *only_main_branches
      - test-validator-package:
          requires:
            - compile-validator-package
          context:
            - ghcr-credentials
          <<: *ignore_main_branches
      #          <<: *only_main_branches
      - build-chainflip-engine:
          requires:
            - test-validator-package
          context:
            - ghcr-credentials
          <<: *ignore_main_branches
      #          <<: *only_main_branches
      - build-state-chain-node:
          requires:
            - test-validator-package
          context:
            - ghcr-credentials
          <<: *ignore_main_branches
#          <<: *only_main_branches
jobs:
  build-rust-base:
    executor: docker/docker
    steps:
      - setup_remote_docker:
          version: 19.03.13
          docker_layer_caching: true
      - checkout
      - docker/check:
          docker-username: DOCKER_USERNAME
          registry: ghcr.io
      - docker/build:
          image: chainflip-io/chainflip-backend/rust-base
          cache_from: ghcr.io/chainflip-io/chainflip-backend/rust-base:latest
          dockerfile: Dockerfile.rust-base
          registry: ghcr.io
      - docker/push:
          registry: ghcr.io
          image: chainflip-io/chainflip-backend/rust-base
          tag: latest

  build-chainflip-engine:
    <<: *chainflip-docker-base
    environment:
      IMAGE: ghcr.io/chainflip-io/chainflip-backend/chainflip-engine
      TAG: <<pipeline.git.revision>>
      BUILD_ARGS: "--build-arg SERVICE=chainflip-engine"

  build-state-chain-node:
    <<: *chainflip-docker-base
    environment:
      IMAGE: ghcr.io/chainflip-io/chainflip-backend/state-chain-node
      TAG: <<pipeline.git.revision>>
      BUILD_ARGS: "--build-arg SERVICE=state-chain-node"

  fmt-validator-package:
    docker:
      - image: ghcr.io/chainflip-io/chainflip-backend/rust-base:latest
        auth: *dockerconfig
    steps:
      - checkout
      - run: >
          cargo fmt -p chainflip-engine
          -p cf-p2p
          -p cf-p2p-rpc
          -p pallet-cf-auction
          -p pallet-cf-emissions
          -p pallet-cf-flip
          -p pallet-cf-rewards
          -p pallet-cf-reputation
          -p pallet-cf-staking
          -p pallet-cf-validator
          -p pallet-cf-vaults
          -p pallet-cf-witnesser
          -p pallet-cf-witnesser-api
          -p cf-traits
          -- --check
      - run: if ! sccache -s; then echo 'warning - sccache is unhealthy'; fi

  check-validator-package:
    <<: *cargo-base-job
    steps:
      - checkout
      - run: sccache -s
      - run: cargo build --locked --release

  test-validator-package:
    <<: *cargo-base-job
    steps:
      - checkout
      - run: sccache -s
      - run: cargo test --locked --lib --release

  compile-validator-package:
    <<: *cargo-base-job
    steps:
      - checkout
      - run: sccache -s
      - run: cargo build --locked --release
      - discord/status:
          fail_only: true
          failure_message: ":red_circle: Build failure on $CIRCLE_BRANCH | $CIRCLE_BUILD_URL"
          only_for_branches: "develop,main"
          webhook: $DW_ALERTS_STAGING
