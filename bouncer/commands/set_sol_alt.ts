#!/usr/bin/env -S pnpm tsx
// INSTRUCTIONS

import { runWithTimeoutAndExit } from '../shared/utils';
import { submitGovernanceExtrinsic } from '../shared/cf_governance';


// This command is for the upgrade test when updating Solana images. The deployment of Solana ALTs is non-deterministic
// and it's address can't be known. Therefore each image will have its own ALT address. This is problematic in the 
// upgrade test because the protocol uses the ALT address from the previous image. Then when we patch the upgrade test
// by initializing with the new image, the ALT doesn't exist and the transactions will fail. This is the same problem
// as with nonces, which need to be forced in the upgrade test via governance.
// For the ALT address we don't have a governance extrinsic to update it because in production it doesn't make sense.
export async function updateAlt() {
  const decodeHexStringToByteArray = (hex: string) => {
    let hexString = hex;
    const result = [];
    while (hexString.length >= 2) {
      result.push(parseInt(hexString.substring(0, 2), 16));
      hexString = hexString.substring(2, hexString.length);
    }
    return result;
  };

  // Old ALT: bc030f4a86b4c5dd809993bd6578ea6e732b272de2e43d1109f5a98f7dc53c28
  // newStorage: "0x72b5d2051d300b10b74314b7e25ace9998ca66eb2c7fbc10ef130dd67028293ca1e031c8bc9bec3b610cf7b36eb3bf3aa40237c9e5be2c7893878578439eb00b5bb5fb93a33acc6b643372110bcc60b86d17ac80836ebb8cdf08e56d4bea3b340fb9ba52b1f09445f1e3a7508d59f0797923acf744fbe2da303fb06da859ee8779c03bceb9ddea819e956b2b332e87fbbf49fc8968df78488e88cfaa366f30361ef91c791d2aa8492c90f12540abd10056ce5dd8d9ab08461476c1dcc16229381c1f0efc91eeb48bb80c90cf97775cd5d843a96f16500266cee2c20d053152d22ec25ce83748eb28232064bd8f41d4f0e7e0cc1186b8704eabdb2461ef50e12cbc030f4a86b4c5dd809993bd6578ea6e732b272de2e43d1109f5a98f7dc53c280501a1e031c8bc9bec3b610cf7b36eb3bf3aa40237c9e5be2c7893878578439eb00b06a7d517192c568ee08a845f73d29788cf035c3145b21ab344d8062ea940000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a95bb5fb93a33acc6b643372110bcc60b86d17ac80836ebb8cdf08e56d4bea3b3479c03bceb9ddea819e956b2b332e87fbbf49fc8968df78488e88cfaa366f30360fb9ba52b1f09445f1e3a7508d59f0797923acf744fbe2da303fb06da859ee8706a7d517187bd16635dad40455fdc2c0c124c68f215675a5dbbacb5f080000001c1f0efc91eeb48bb80c90cf97775cd5d843a96f16500266cee2c20d053152d2c8bb64258728f7a98b57a72fade81639eb845674b3d259b51991a97a1821a319069b8857feab8184fb687f634618c035dac439dc1aeb3b5598a0f000000000018c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f859000000000000000000000000000000000000000000000000000000000000000072b5d2051d300b10b74314b7e25ace9998ca66eb2c7fbc10ef130dd67028293c1ef91c791d2aa8492c90f12540abd10056ce5dd8d9ab08461476c1dcc16229382ec25ce83748eb28232064bd8f41d4f0e7e0cc1186b8704eabdb2461ef50e12c17eb2b10d3377bda2bc7bea65bec6b8372f4fc3463ec2cd6f9fde4b2c633d192f4f83bd213a59c9785110cf83c718f9486c3484f918593bce20c61dc6a96036af0f13460b3fd04b7d53d7421fc874ec00eec769cf36480895e1a407bf1249475f2b2e24122be016983be9369965246cc45e1f621d40fba300c56c7ac50c3874de392cd98d3284fd551604be95c14cc8e20123e2940ef9fb784e6b591c7442864cd644e45426a41a7cb8369b8a0c1c89bb3f86cf278fdd9cc38b0f69784ad56678541f57201f277c5f3ffb631d0212e26e7f47749c26c4808718174a0ab2a09a1fecc89e3b031824af6363174d19bbec12d3a13c4a173e5aeb349b63042bc138fe5e1869817a4fd88ddf7ab7a5f7252d7c345b39721769888608592912e8ca9ac8cd28baa84f2067bbdf24513c2d44e44bf408f2e6da6e60762e3faa4a62a0adb99f83fd0cbc4a102ebb61dbc7e4ac14e015f75926b07dfc29502849e150eef8feceb1b2a17f291f87b9360a370aed7853d2cf018c6e3f6d3809e5c7aaaebf10a29d34d2f8104f4377d4c51b4d12f5e4ef5e02a42a11310e94b5c123414b7afe17c2563f465e96bce522976c223a00f70df761ce5ba852a5d2a3b0f1d4a8e5dbf893235b7724e606dd7e247fb4d2444e28fe1f84030ff397f92f344f5694503978b724b9387bcc6bf2567eb1acc386b63c2d0d2e6a6356d3579582b6671bb050b33283a914df8c848dc6be1ebca25f51eb9b19e5e04d21844740d4f7680d52451da265e7d7939bec72cc6f75c505769ca2e31ca6666f0f9a0f7cddfca3909ec37c6a34bd0e8d14e9176898178f6c1129d148702d6146acdc7cc98dea4b7860a90f820a0d6ea8f9783b95a50be2ee9575b0d167e98a15f5d156a2a95b74e9871de18b6d732353815e16a3ae74dab952606147eb71e39056c7144316008881ef201f78c5eaaed13e0658c6c451c7848694633f205f252878591113a14c36cd968d6bf0f76f9921ca1c18aa4aaed2f13df64ae2852f5954da3eac1c6d17bc4c392c6f0aefbed4df4b019c12c45e5e73dedc3873e81027e86576d77d84ac5b5c2b13cd3aeb80c97a91de870e0f615c283bdcab6298b360dc06bebca7eb688c62fa5058e497278fdf7184e6dcf33c5e173cde93b36b4ab8757ffccf1dd3cce4c6c8af041de6f9e9c3e534a047f0ca770d4d3d9523e5769f3e5307ae0a7f54bfbb632a3af72f186abb9eb29ee4132fc8b78cb54c089816784b660b9518abc3e778f04e93803d5bc5b724e0d754dc23797dca211216081f0814b9bac5988c326fa67617e98cf15f6e52484757cc5407fa0c1bdb49c7d821a0576bc0186e00d174e5c817ac5b9b5402bdb66cda189af7590e4694a460b4c9676de5d6d9b0b66ce0a10dddf992687fe7287e584f6b17339c2fd5644ce32f0b047c07844c8b18b32cd682ffacc5e197bfa353817ddca535966680a2369b53dea33c4f136b9a720816021724dadac439464067ec6e38dd167cf67b537bf71a15ae418936c7c0cea9fd92feb140ec570d4a45c527fd0b463d18054a3c97ffe396700b700fedbfefc30a2bf06b01644495ba3589884605e30f4f7198feab22512ed64ad3b0e4203d6483d7209b18608d6b2ff08a15622cfbf7aa1d521fe75bcbd388914ac981649e72b27f5fb22823affb76884b483ac2e2bebadb6978fdd53a5fc5d9aa2e5b29f17b9f81b0f19289c81dc6674f5bdc9e29294472d527b5ce76133227ceadf500f232ef3188f9967fa31ad98caa29455038a3f76058b988a879c0e6277f65edf0c404a2af6c58c30945c158f9d847a5cd7b3d1e821820f40fa6a20dacd3524c7ffcd5619930ff88ad64a01a18d9e8af3fab762db40798c81385de7c39d1eda33bbe06bf0663c9ea1ea51dbd42ff6f7acf62da5819d33fee38a5ecf511ce7fd0f8da61fd85154e9ec7f10dc93d42c8d7e65af610d9e2428ade99925075eb895cf186d7c3609633a13cfe7b97551a3830ef9214b106d62af19e6544f1319d85c9f4b64359a0890aaa95f00c24ba183ef331df5f68b146b0309abb282e933e8a4180629768bc7eb03b14e24bcca7f43d8662dd3ec4e47b74488abf22e514c8d89fdf4bea5f709a58be288c4fc9a925567820c626dea2a8ed21416e3e6c6408f72ca8d1ccbd0f037e76211cd0ccf678acf7f4f4fc0f1e59cd96dfa4b849aa5da2a354eefd86b21e2d9c4e50c3be08b096bc0f8682decbbb0d2c1acca02ed61f99b2c412771239c6f49"
  // TODO: To update with right address that matches the utils USER_ADDRESS_LOOKUP_TABLE
  // New ALT: G2wCNFGQHKTteiwAGf8nyRVHAbaZnqGg15HRyRjhugBf => df5e2a0e83a3ccc7479e47e694ccd57538423777652ca38aa58e35d4b64723c6
  const newStorage = "0x72b5d2051d300b10b74314b7e25ace9998ca66eb2c7fbc10ef130dd67028293ca1e031c8bc9bec3b610cf7b36eb3bf3aa40237c9e5be2c7893878578439eb00b5bb5fb93a33acc6b643372110bcc60b86d17ac80836ebb8cdf08e56d4bea3b340fb9ba52b1f09445f1e3a7508d59f0797923acf744fbe2da303fb06da859ee8779c03bceb9ddea819e956b2b332e87fbbf49fc8968df78488e88cfaa366f30361ef91c791d2aa8492c90f12540abd10056ce5dd8d9ab08461476c1dcc16229381c1f0efc91eeb48bb80c90cf97775cd5d843a96f16500266cee2c20d053152d22ec25ce83748eb28232064bd8f41d4f0e7e0cc1186b8704eabdb2461ef50e12cdf5e2a0e83a3ccc7479e47e694ccd57538423777652ca38aa58e35d4b64723c60501a1e031c8bc9bec3b610cf7b36eb3bf3aa40237c9e5be2c7893878578439eb00b06a7d517192c568ee08a845f73d29788cf035c3145b21ab344d8062ea940000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a95bb5fb93a33acc6b643372110bcc60b86d17ac80836ebb8cdf08e56d4bea3b3479c03bceb9ddea819e956b2b332e87fbbf49fc8968df78488e88cfaa366f30360fb9ba52b1f09445f1e3a7508d59f0797923acf744fbe2da303fb06da859ee8706a7d517187bd16635dad40455fdc2c0c124c68f215675a5dbbacb5f080000001c1f0efc91eeb48bb80c90cf97775cd5d843a96f16500266cee2c20d053152d2c8bb64258728f7a98b57a72fade81639eb845674b3d259b51991a97a1821a319069b8857feab8184fb687f634618c035dac439dc1aeb3b5598a0f000000000018c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f859000000000000000000000000000000000000000000000000000000000000000072b5d2051d300b10b74314b7e25ace9998ca66eb2c7fbc10ef130dd67028293c1ef91c791d2aa8492c90f12540abd10056ce5dd8d9ab08461476c1dcc16229382ec25ce83748eb28232064bd8f41d4f0e7e0cc1186b8704eabdb2461ef50e12c17eb2b10d3377bda2bc7bea65bec6b8372f4fc3463ec2cd6f9fde4b2c633d192f4f83bd213a59c9785110cf83c718f9486c3484f918593bce20c61dc6a96036af0f13460b3fd04b7d53d7421fc874ec00eec769cf36480895e1a407bf1249475f2b2e24122be016983be9369965246cc45e1f621d40fba300c56c7ac50c3874de392cd98d3284fd551604be95c14cc8e20123e2940ef9fb784e6b591c7442864cd644e45426a41a7cb8369b8a0c1c89bb3f86cf278fdd9cc38b0f69784ad56678541f57201f277c5f3ffb631d0212e26e7f47749c26c4808718174a0ab2a09a1fecc89e3b031824af6363174d19bbec12d3a13c4a173e5aeb349b63042bc138fe5e1869817a4fd88ddf7ab7a5f7252d7c345b39721769888608592912e8ca9ac8cd28baa84f2067bbdf24513c2d44e44bf408f2e6da6e60762e3faa4a62a0adb99f83fd0cbc4a102ebb61dbc7e4ac14e015f75926b07dfc29502849e150eef8feceb1b2a17f291f87b9360a370aed7853d2cf018c6e3f6d3809e5c7aaaebf10a29d34d2f8104f4377d4c51b4d12f5e4ef5e02a42a11310e94b5c123414b7afe17c2563f465e96bce522976c223a00f70df761ce5ba852a5d2a3b0f1d4a8e5dbf893235b7724e606dd7e247fb4d2444e28fe1f84030ff397f92f344f5694503978b724b9387bcc6bf2567eb1acc386b63c2d0d2e6a6356d3579582b6671bb050b33283a914df8c848dc6be1ebca25f51eb9b19e5e04d21844740d4f7680d52451da265e7d7939bec72cc6f75c505769ca2e31ca6666f0f9a0f7cddfca3909ec37c6a34bd0e8d14e9176898178f6c1129d148702d6146acdc7cc98dea4b7860a90f820a0d6ea8f9783b95a50be2ee9575b0d167e98a15f5d156a2a95b74e9871de18b6d732353815e16a3ae74dab952606147eb71e39056c7144316008881ef201f78c5eaaed13e0658c6c451c7848694633f205f252878591113a14c36cd968d6bf0f76f9921ca1c18aa4aaed2f13df64ae2852f5954da3eac1c6d17bc4c392c6f0aefbed4df4b019c12c45e5e73dedc3873e81027e86576d77d84ac5b5c2b13cd3aeb80c97a91de870e0f615c283bdcab6298b360dc06bebca7eb688c62fa5058e497278fdf7184e6dcf33c5e173cde93b36b4ab8757ffccf1dd3cce4c6c8af041de6f9e9c3e534a047f0ca770d4d3d9523e5769f3e5307ae0a7f54bfbb632a3af72f186abb9eb29ee4132fc8b78cb54c089816784b660b9518abc3e778f04e93803d5bc5b724e0d754dc23797dca211216081f0814b9bac5988c326fa67617e98cf15f6e52484757cc5407fa0c1bdb49c7d821a0576bc0186e00d174e5c817ac5b9b5402bdb66cda189af7590e4694a460b4c9676de5d6d9b0b66ce0a10dddf992687fe7287e584f6b17339c2fd5644ce32f0b047c07844c8b18b32cd682ffacc5e197bfa353817ddca535966680a2369b53dea33c4f136b9a720816021724dadac439464067ec6e38dd167cf67b537bf71a15ae418936c7c0cea9fd92feb140ec570d4a45c527fd0b463d18054a3c97ffe396700b700fedbfefc30a2bf06b01644495ba3589884605e30f4f7198feab22512ed64ad3b0e4203d6483d7209b18608d6b2ff08a15622cfbf7aa1d521fe75bcbd388914ac981649e72b27f5fb22823affb76884b483ac2e2bebadb6978fdd53a5fc5d9aa2e5b29f17b9f81b0f19289c81dc6674f5bdc9e29294472d527b5ce76133227ceadf500f232ef3188f9967fa31ad98caa29455038a3f76058b988a879c0e6277f65edf0c404a2af6c58c30945c158f9d847a5cd7b3d1e821820f40fa6a20dacd3524c7ffcd5619930ff88ad64a01a18d9e8af3fab762db40798c81385de7c39d1eda33bbe06bf0663c9ea1ea51dbd42ff6f7acf62da5819d33fee38a5ecf511ce7fd0f8da61fd85154e9ec7f10dc93d42c8d7e65af610d9e2428ade99925075eb895cf186d7c3609633a13cfe7b97551a3830ef9214b106d62af19e6544f1319d85c9f4b64359a0890aaa95f00c24ba183ef331df5f68b146b0309abb282e933e8a4180629768bc7eb03b14e24bcca7f43d8662dd3ec4e47b74488abf22e514c8d89fdf4bea5f709a58be288c4fc9a925567820c626dea2a8ed21416e3e6c6408f72ca8d1ccbd0f037e76211cd0ccf678acf7f4f4fc0f1e59cd96dfa4b849aa5da2a354eefd86b21e2d9c4e50c3be08b096bc0f8682decbbb0d2c1acca02ed61f99b2c412771239c6f49"

  await submitGovernanceExtrinsic((api) =>
    api.tx.governance.callAsSudo(
      api.tx.system.setStorage([
        [
          // Environment pallet's solanaApiEnvironment
          decodeHexStringToByteArray("ea74517f3c97f142e2fa95ff896cfe9fc5dcbcfef6c398102c351b5af0c071ad"),
          newStorage,
        ],
      ]),
    ),
  );
}

await runWithTimeoutAndExit(updateAlt(), 20);
