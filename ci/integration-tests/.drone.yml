#  Runs all tests at night
kind: pipeline
type: kubernetes
name: chainflip-backend-nightly

environment:
  SCCACHE_REDIS: redis://drone-redis-headless:6379/
  SCCACHE_CACHE_SIZE: 14G

clone:
  disable: true

services:
  - image: nats:latest
    ports: [4222, 8222]
    name: nats

steps:
  - name: clone
    image: alpine/git
    commands:
      - git clone https://github.com/chainflip-io/chainflip-backend.git .
      - git clone https://github.com/chainflip-io/chainflip-eth-contracts.git eth-contracts
  - name: hardhat-setup
    depends_on:
      - clone
    image: node:14-alpine
    commands:
      - cd eth-contracts
      - npm install
  - name: hardhat-start
    depends_on:
      - hardhat-setup
    image: node:14-alpine
    detach: true
    commands:
      - cd eth-contracts
      - npx hardhat node
  - name: eth-events-setup
    depends_on:
      - hardhat-setup
    image: ghcr.io/chainflip-io/chainflip-eth-contracts/eth-brownie:latest
    commands:
      - cd eth-contracts
      - $HOME/.poetry/bin/poetry install
      - $HOME/.poetry/bin/poetry run brownie run deploy_and all_events --network hardhat
  - name: run-tests
    depends_on:
      - eth-events-setup
    image: ghcr.io/chainflip-io/chainflip-backend/rust-base:latest
    commands:
      - cargo test --locked --release
  - name: notify
    image: appleboy/drone-discord
    when:
      status:
        - failure
    settings:
      username: Integration Tests Bot
      webhook_id:
        from_secret: discord_webhook_id
      webhook_token:
        from_secret: discord_webhook_token
      message: |
        ⚠️ Nightly Integration Tests Failure ⚠️
        Logs: {{build.link}}

# Config
trigger:
  event:
    - cron
  cron:
    - nightly

image_pull_secrets:
  - dockerconfigjson

node_selector:
  type: ci

tolerations:
  - key: "workloadKind"
    operator: "Equal"
    value: "ci"
