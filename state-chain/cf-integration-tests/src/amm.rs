use cf_primitives::Asset;
use cf_traits::{
	AccountRoleRegistry, BalanceApi, FundAccount, FundingSource, LpRegistration, SwappingApi,
	INITIAL_FLIP_FUNDING,
};
use codec::Decode;
use frame_support::{assert_ok, sp_runtime::AccountId32};
use pallet_cf_pools::{AssetAmounts, AssetPair, Pool, Pools, RangeOrderSize};

use cf_chains::eth::H160;
use state_chain_runtime::{
	AccountRoles, AssetBalances, Funding, LiquidityPools, LiquidityProvider, Runtime, RuntimeOrigin,
};

#[test]
fn test_pool_state_overflow() {
	const POOL_VALUE_HEX: &str = "0x142031fec88bece0fa90dfb1e3b87bfa86a9fdf1e43dd99cd4e6e58e4ad3b33f3508adf6fa449a010000fbffffff0a00000075b2d9c99a010000feffffff0c00000031ada265ae86cebc2270e0a09ec64503ba64927246cddf51c8b43752582bc73d044cefefd89a0100000000000006000000375b361ce8faab9743bd77330a79dfbfc348e0c5f03f419871caa2a0536da5580463360198970100009fffffff67000000b4b0b543516af331f30f81108558eb3c0703c8a0e3a84add7e0c451e5567290d04c9ebbad99a010000000000000b000000b65758b888e460ceb94a9ef1a9f6e5edcddd2311f506432e8f0835debde5612d04e454cedd9a010000feffffff0c000000182ce32b9f6e4ed0d5211a2ae097bd009c2fb7125171a010b17dbf54dfad7c2bb0080000000000000000020000000100000000000000070000005cbb9695e4a695e4a74671d323bc3614b3a0661df6b50d29fb2969751eb1bd4b0411000000000000001300000078ed86480251f2394599c5a2ce0a8ea9f4769057cd7ac5b4c6e86378a39aa56704000000000000000001000000d651e19d1a70daf72ec49a2ce4200ae93e434eb409e704ece12343ad78b8e35310f8bd25698b632a3a0a000000e9982ef97bce5d760a0000007c157eda6c19aac80a0000000f5efa0acea264f50a000000d6b8de299026d8f68abe5a2e79142818d1f2dfa9a2b0b17cf87457b1d928856904000000000000000001000000f4667ae80b58a251293e407ef3bfff21db1d25243e5c6ab9f67cd4e57462ffff04000000000000000001000000104077c39a4192811fe0fb0af8b4eaa90b2ea3b631c74d385c3b9e6348b27bce4c0481232429166864170100000078ed86480251f2394599c5a2ce0a8ea9f4769057cd7ac5b4c6e86378a39aa567040100000000000000ffffffffd6b8de299026d8f68abe5a2e79142818d1f2dfa9a2b0b17cf87457b1d9288569080000000000000000000000000100000000000000fffffffff4667ae80b58a251293e407ef3bfff21db1d25243e5c6ab9f67cd4e57462ffff040100000000000000ffffffff0000000097a2ae000000000000000000000000003410d05ae52a6711ffd646030001000000000000000000000000000000000000004fa2ae000000000000000000000000003049ab000600000000000000000000000000000000000000000000000000000027031b9ba81a73d48614990ce70786f90efc26575144e516524a562b661e73de00000000000000000000000000000000000000000000000000000000000000001c9e5e29cb10c7bab88d060001000000000000000000000000000000000000004ca2ae0000000000000000000000000026e8899d00000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000eca489e1662b4433a5d4090001000000000000000000000000000000000000009da1ae00000000000000000000000000280000000000000000000000000000000000000000000000000000000000000092108c357b746917bc60ebb18b1491a392f3430bb6ac4d5bd92d178064fe98bb000000000000000000000000000000000000000000000000000000000000000076fb306bf7e5ab689c1b0d00010000000000000000000000000000000000000096a1ae00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000030fe112b5253452c106da479cb815a294b9babad2453d51c2ad2329bb776b4c0000000000000000000000000000000000000000000000000000000000000000022b955d81cf9c70aaba9130001000000000000000000000000000000000000006aa1ae000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000b39070c897f87de82de46416997ed8576662fbe946aa13605802b45e87bea4df00000000000000000000000000000000000000000000000000000000000000000761f7eae4b1c277c2f0160001000000000000000000000000000000000000004da2ae0000000000000000000000000026e8899d00000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000526e513008cb34a2e4371a000100000000000000000000000000000000000000449fae0000000000000000000000000001000000000000000000000000000000000000000000000000000000000000002c6f2ecd96d71dbe899ec428b444597453e5fe1a74b4cc8d4682bb2536399ff4000000000000000000000000000000000000000000000000000000000000000077ea870ebbe30b3049c620000100000000000000000000000000000000000000b19dae000000000000000000000000008fc40c5e00000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000008fcf4a54cbf7347521493e000100000000000000000000000000000000000000d78bae000000000000000000000000001a2ed6c809000000000000000000000000000000000000000000000000000000583f7e6aa6586144dcb15a424e14ca5c1a375696216424909f3eab72cc884de9040000000000000000000000000000000000000000000000000000000000000046b6e03ac07b80d8b303f90301000000000000000000000000000000000000009f8aae0000000000000000000000000008000000000000000000000000000000000000000000000000000000000000005485f509aee4aaa68a35fbff15a5092629d4b6d6f01170c03d1e3c0e0f74af8d0000000000000000000000000000000000000000000000000000000000000000fe737340098e93347cfb0c040100000000000000000000000000000000000000868aae000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000ee50f40b959202e0e5632e1fc569102127fdeeacdfd7b805d1ce18673257b7e80000000000000000000000000000000000000000000000000000000000000000b5957d8f742fa69cf3f716040100000000000000000000000000000000000000157fae000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000aa27220da526ec27eb0dd128aba924bcfe34672c1e79b0e3a9c0568964ffa4dd0000000000000000000000000000000000000000000000000000000000000000de6bbb61cb2e32c179a01d0401000000000000000000000000000000000000000e7fae000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000df40e12a03c3c581a1015fe93aac2b1d5dbe6f125607b9145f53f2a44c9b01fc00000000000000000000000000000000000000000000000000000000000000002cec620d5d45fd152e6b3bc8fc00000000000000000000000000000000000000007bcb0000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000059393ed37addf6c7f4b376af1d05b7d3aa207f98a230b2dd6c9188b39b48ceff0000000000000000000000000000000000000000000000000000000000000000beb1c53f6f0f307a5a736dfd00000000000000000000000000000000000000009a7278000000000000000000000000002a000000000000000000000000000000000000000000000000000000000000009a28d5f06ae03ad9e3dbf9f4695348aea39832e3fbe39f2c5d12451e22e4d3bb0200000000000000000000000000000000000000000000000000000000000000351aa9706aaf8b3a41aeb4ff0000000000000000000000000000000000000000105dae000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000568ac554cac4572c06bcc8435f0375987273b1f3d62104ed1a3865ca91d9e2ae02000000000000000000000000000000000000000000000000000000000000005226e6a2a6577a580c3abbff0000000000000000000000000000000000000000f163ae0000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000c1cb1160cc5a121310d696509409ba415a78e4a3c4df3c5e8dd6d84e9c6cf93000000000000000000000000000000000000000000000000000000000000000081523a69e928cefd0180beff0000000000000000000000000000000000000000f364ae000000000000000000000000000300000000000000000000000000000000000000000000000000000000000000318ba682889791d809c686bec260bd878e9cc0690e5ee66601fbc66362277ccb00000000000000000000000000000000000000000000000000000000000000004cb850699dd3e35c02c6c1ff00000000000000000000000000000000000000004e65ae0000000000000000000000000001000000000000000000000000000000000000000000000000000000000000004f865de117eca1723b5ccd8e2f0d621f945567353dc67dde8e0dff4f49041f9600000000000000000000000000000000000000000000000000000000000000006a7fc028d57cde750d0cc5ff00000000000000000000000000000000000000006498ae0000000000000000000000000001000000000000000000000000000000000000000000000000000000000000006e3eefafd5e0387f3d9f81a39cc01b75cb09e5571b0717e5136b747b80f89f9f00000000000000000000000000000000000000000000000000000000000000004b0143dfa9e5fcdbe56ad5ff00000000000000000000000000000000000000009298ae00000000000000000000000000010000000000000000000000000000000000000000000000000000000000000019619d022f6af25d4128fb7943717065f1b42821bed146118ae8f9c0ce8fa9eb0000000000000000000000000000000000000000000000000000000000000000dc03324c398df29c4b11e9ff0000000000000000000000000000000000000000059bae000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000e275d1a4cee2a0bc6d95c61a7e8c7645455f93c245f602391379593bb147829d05000000000000000000000000000000000000000000000000000000000000002e162daa37ad6fbd33b9fcff000000000000000000000000000000000000000068a2ae00000000000000000000000000442e1a6f070000000000000000000000000000000000000000000000000000008ab0d8471b497eeafec743cd59c838a963c6ad6603d71282eb4a02459d1a15c9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000006ba2ae000000000000000000000000009b7d191400000000000000000000000000000000000000000000000000000000417f52a1333067f5fccf289c2411bec2dbebe8c70ce1e96b42fb87c31514c9bd00000000000000000000000000000000000000000000000000000000000000002810d05ae52a6711ffd6460300010000000000000000000000000000000000000078ed86480251f2394599c5a2ce0a8ea9f4769057cd7ac5b4c6e86378a39aa56700000000000000004fa2ae00000000000000000000000000362c3e2902000000000000000000000000000000000000000000000000000000f8df43c9a3c5893fc566e2a27fb3a13730a1d117c6034fd86114d43e8a86a5e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000362c3e290200000000000000000000000000000000000000000000000000000010d05ae52a6711ffd64603000100000000000000000000000000000000000000d6b8de299026d8f68abe5a2e79142818d1f2dfa9a2b0b17cf87457b1d928856900000000000000004fa2ae000000000000000000000000001daaad0901000000000000000000000000000000000000000000000000000000f8df43c9a3c5893fc566e2a27fb3a13730a1d117c6034fd86114d43e8a86a5e8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001daaad090100000000000000000000000000000000000000000000000000000010d05ae52a6711ffd64603000100000000000000000000000000000000000000f4667ae80b58a251293e407ef3bfff21db1d25243e5c6ab9f67cd4e57462ffff00000000000000004fa2ae0000000000000000000000000084fb2f1403000000000000000000000000000000000000000000000000000000f8df43c9a3c5893fc566e2a27fb3a13730a1d117c6034fd86114d43e8a86a5e80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000084fb2f14030000000000000000000000000000000000000000000000000000001c9e5e29cb10c7bab88d060001000000000000000000000000000000000000002ce32b9f6e4ed0d5211a2ae097bd009c2fb7125171a010b17dbf54dfad7c2bb000000000000000004ca2ae0000000000000000000000000026e8899d00000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000026e8899d000000000000000000000000000000000000000000000000000000000761f7eae4b1c277c2f0160001000000000000000000000000000000000000002ce32b9f6e4ed0d5211a2ae097bd009c2fb7125171a010b17dbf54dfad7c2bb001000000000000004da2ae0000000000000000000000000026e8899d00000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000026e8899d0000000000000000000000000000000000000000000000000000000077ea870ebbe30b3049c620000100000000000000000000000000000000000000d651e19d1a70daf72ec49a2ce4200ae93e434eb409e704ece12343ad78b8e353f8bd25698b632a3ab19dae00000000000000000000000000dba6b40500000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000dba6b4050000000000000000000000000000000000000000000000000000000077ea870ebbe30b3049c620000100000000000000000000000000000000000000d651e19d1a70daf72ec49a2ce4200ae93e434eb409e704ece12343ad78b8e353e9982ef97bce5d76b19dae00000000000000000000000000a025134000000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a02513400000000000000000000000000000000000000000000000000000000077ea870ebbe30b3049c620000100000000000000000000000000000000000000d651e19d1a70daf72ec49a2ce4200ae93e434eb409e704ece12343ad78b8e3537c157eda6c19aac8b19dae000000000000000000000000005da7f10800000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005da7f1080000000000000000000000000000000000000000000000000000000077ea870ebbe30b3049c620000100000000000000000000000000000000000000d651e19d1a70daf72ec49a2ce4200ae93e434eb409e704ece12343ad78b8e3530f5efa0acea264f5b19dae00000000000000000000000000b750530f00000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b750530f000000000000000000000000000000000000000000000000000000008fcf4a54cbf7347521493e0001000000000000000000000000000000000000005cbb9695e4a695e4a74671d323bc3614b3a0661df6b50d29fb2969751eb1bd4b1100000000000000d78bae00000000000000000000000000162ed6c809000000000000000000000000000000000000000000000000000000583f7e6aa6586144dcb15a424e14ca5c1a375696216424909f3eab72cc884de904000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000162ed6c809000000000000000000000000000000000000000000000000000000142e162daa37ad6fbd33b9fcff000000000000000000000000000000000000000078ed86480251f2394599c5a2ce0a8ea9f4769057cd7ac5b4c6e86378a39aa567010000000000000068a2ae0000000000000000000000000033b25198020000000000000000000000000000000000000000000000000000008ab0d8471b497eeafec743cd59c838a963c6ad6603d71282eb4a02459d1a15c90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000033b25198020000000000000000000000000000000000000000000000000000002e162daa37ad6fbd33b9fcff0000000000000000000000000000000000000000d6b8de299026d8f68abe5a2e79142818d1f2dfa9a2b0b17cf87457b1d9288569010000000000000068a2ae0000000000000000000000000001525924010000000000000000000000000000000000000000000000000000008ab0d8471b497eeafec743cd59c838a963c6ad6603d71282eb4a02459d1a15c90000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001525924010000000000000000000000000000000000000000000000000000002e162daa37ad6fbd33b9fcff0000000000000000000000000000000000000000f4667ae80b58a251293e407ef3bfff21db1d25243e5c6ab9f67cd4e57462ffff010000000000000068a2ae000000000000000000000000000e2a6fb2030000000000000000000000000000000000000000000000000000008ab0d8471b497eeafec743cd59c838a963c6ad6603d71282eb4a02459d1a15c9000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e2a6fb2030000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000d6b8de299026d8f68abe5a2e79142818d1f2dfa9a2b0b17cf87457b1d928856900000000000000006ba2ae00000000000000000000000000e4a7ab1a000000000000000000000000000000000000000000000000000000005f4e241b2f856a2b1d6d758afc2d4d640168bba8cbd13f30b161f18e6987d4fb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e4a7ab1a0000000000000000000000000000000000000000000000000000000010d05ae52a6711ffd646030001000000000000000000000000000000000000004077c39a4192811fe0fb0af8b4eaa90b2ea3b631c74d385c3b9e6348b27bce4c812324291668641796a2ae00000000000000000000000000a07b290300000000000000000000000000000000000000000000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000a07b290300000000000000000000000000000000000000000000000000000000dc8888f406000000000000000000000000000000000000000000000000000000b91d952c150000000000000000000000000000000000000000000000000000000d05939afbe40000000000000000000000000000000000000000000000000000f5e4a1a2798a020000000000000000000000000000000000000000000000000009fd1bf7e289020000000000000000000000000000000000000000000000000008f38a5cfae40000000000000000000000000000000000000000000000000000f4010000708aab7b469a5d64b473f9ff0000000000000000000000000000000000000000feffffffc27c4df9070600000000000000000000cff855ed05bf3343aeab8e6249bc32000000000000000000000000000000000051c1ab45d0999107803885fe5cbe3200000000000000000000000000000000002c1876f2ff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009fffffff2d740baf1800000000000000000000002d740baf1800000000000000000000007c44da5a2e2a160370638b9854321c0000000000000000000000000000000000a2fab9e7442e3d18da85f3d7d71e1c0000000000000000000000000000000000fbffffffa860941f8d0000000000000000000000a860941f8d0000000000000000000000bbe83af6a149ea056be75115c3292f0000000000000000000000000000000000b086d36c30801146b2d361330f292f0000000000000000000000000000000000feffffffeda7ad2a620500000000000000000000eda7ad2a620500000000000000000000e00800c855c9c20c40d98da2567632000000000000000000000000000000000007ac73bac895460ca1e58e8f1c7b320000000000000000000000000000000000000000005e9cd330540c000000000000000000005e9cd330540c0000000000000000000084bab628e5b2ec33e6ca9db0530b000000000000000000000000000000000000b7d347b78dc3b8949a384b193c0900000000000000000000000000000000000006000000065ce18519fcfffffffffffffffffffffaa31e7ae603000000000000000000009e0328a73d69f562c13ec6cf4a06000000000000000000000000000000000000a18819dc470d0e217e1ae82c4c060000000000000000000000000000000000000a000000589f6be072ffffffffffffffffffffffa860941f8d0000000000000000000000cade0eab059a754193bebf15b224030000000000000000000000000000000000095ac0ab116dbf028886faf9ac280300000000000000000000000000000000000b0000009c074b4992f7ffffffffffffffffffff64f8b4b66d080000000000000000000056c7beffe1f68b3fa86f0d0a1902000000000000000000000000000000000000be2240ca93129130ca8b657d19020000000000000000000000000000000000000c000000135852d59dfaffffffffffffffffffffeda7ad2a620500000000000000000000ab4df3dcb70e1a34b0e762ff442a000000000000000000000000000000000000fce3f4a98b4d3712e5f0df3d7e2a00000000000000000000000000000000000067000000d38bf450e7ffffffffffffffffffffff2d740baf18000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000e8890d00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000182031fec88bece0fa90dfb1e3b87bfa86a9fdf1e43dd99cd4e6e58e4ad3b33f35adf6fa449a010000fbffffff0a000000a860941f8d00000000000000000000008dd2d62e6a13b808f404b9381555000000000000000000000000000000000000511d3c34f20e020f5ed19c1fcf5600000000000000000000000000000000000022e72e0000000000000000000000000000000000000000000000000000000000c3da2f0000000000000000000000000000000000000000000000000000000000bc467d8da8f390381948030001000000000000000000000000000000000000002031fec88bece0fa90dfb1e3b87bfa86a9fdf1e43dd99cd4e6e58e4ad3b33f3575b2d9c99a010000feffffff0c00000073ec8fe41704000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b2dec274d0a820a5e0631000010000000000000000000000000000000000000031ada265ae86cebc2270e0a09ec64503ba64927246cddf51c8b43752582bc73d4cefefd89a0100000000000006000000faa31e7ae603000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b2dec274d0a820a5e06310000100000000000000000000000000000000000000375b361ce8faab9743bd77330a79dfbfc348e0c5f03f419871caa2a0536da55863360198970100009fffffff670000002d740baf180000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000098478e3a7e1f8baede1c0d000100000000000000000000000000000000000000b4b0b543516af331f30f81108558eb3c0703c8a0e3a84add7e0c451e5567290dc9ebbad99a010000000000000b00000064f8b4b66d0800000000000000000000fdd9c3c27e6321c7243b13666b0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000098478e3a7e1f8baede1c0d000100000000000000000000000000000000000000b65758b888e460ceb94a9ef1a9f6e5edcddd2311f506432e8f0835debde5612de454cedd9a010000feffffff0c0000007abb1d464a01000000000000000000009bbceb5d6ac0c2dcc871bed9bd180000000000000000000000000000000000004e3143e17bb613e9f9611631c21800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000b2dec274d0a820a5e06310000100000000000000000000000000000000000000dc6c81a1000000000000000000000000000000000000000000000000000000005e93e7ac00000000000000000000000000000000000000000000000000000000db72b220ed040000000000000000000000000000000000000000000000000000aa8ead2346050000000000000000000000000000000000000000000000000000249de7fb44050000000000000000000000000000000000000000000000000000c9656046ee040000000000000000000000000000000000000000000000000000";
	super::genesis::with_test_defaults().build().execute_with(|| {
		let pool_value_bytes =
			hex::decode(POOL_VALUE_HEX.replace("0x", "")).expect("Failed to decode pool value hex");

		let pool: Pool<Runtime> =
			Decode::decode(&mut &pool_value_bytes[..]).expect("Failed to decode Pool from hex");

		let asset_pair = AssetPair::new(Asset::Usdt, Asset::Usdc).expect("Invalid asset pair");
		Pools::<Runtime>::insert(asset_pair, pool);

		let lp_account = AccountId32::from([9; 32]);
		Funding::fund_account(
			lp_account.clone(),
			INITIAL_FLIP_FUNDING,
			FundingSource::InitialFunding { channel_id: Some(0), asset: Asset::Flip },
		);
		assert_ok!(AccountRoles::register_account_role(
			&lp_account,
			cf_primitives::AccountRole::LiquidityProvider,
		));
		<LiquidityProvider as LpRegistration>::register_liquidity_refund_address(
			&lp_account,
			cf_chains::ForeignChainAddress::Eth(H160([1; 20])),
		);

		// Credit enough balance for the position and swaps
		AssetBalances::credit_account(&lp_account, Asset::Usdt, 1_000_000_000_000);
		AssetBalances::credit_account(&lp_account, Asset::Usdc, 1_000_000_000_000);

		// The exact call that caused the panic, tick range 0..12 is the problematic argument.
		// With wrapping arithmetic fix, this succeed.
		let order_id = 0x0000019adf202a3a;
		assert_ok!(LiquidityPools::set_range_order(
			RuntimeOrigin::signed(lp_account.clone()),
			Asset::Usdt,
			Asset::Usdc,
			order_id,
			Some(0..12), // The problematic tick range that causes underflow
			RangeOrderSize::AssetAmounts {
				maximum: AssetAmounts { base: 900_000u128, quote: 0u128 },
				minimum: AssetAmounts { base: 0u128, quote: 0u128 },
			},
		));

		// === Now verify fees work correctly with the wrapping fix ===
		println!("\n=== Testing fee calculation after wrapping fix ===");

		// Perform swaps to generate fees
		println!("Performing swaps to generate fees...");
		for _i in 0..10 {
			let _result = LiquidityPools::swap_single_leg(Asset::Usdc, Asset::Usdt, 1_000_000_000);
		}

		for _i in 0..10 {
			let _result = LiquidityPools::swap_single_leg(Asset::Usdt, Asset::Usdc, 1_000_000_000);
		}

		// Collect fees by updating the position (set_range_order with None for range)
		// This triggers fee collection and verifies wrapping math works correctly
		let collect_result = LiquidityPools::set_range_order(
			RuntimeOrigin::signed(lp_account.clone()),
			Asset::Usdt,
			Asset::Usdc,
			order_id,
			None,
			RangeOrderSize::Liquidity { liquidity: 0 },
		);
		assert_ok!(collect_result);
	});
}
