on:
  workflow_call:
jobs:
  fetch:
    strategy:
      fail-fast: true
      matrix:
        ubuntu_version: [20.04, 22.04]
    runs-on: ubuntu-${{ matrix.ubuntu_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Get branch of tag
        shell: bash
        run: |
          RAW=$(./ci/scripts/extract_version.sh ${{ github.ref_name }})
          echo "MAJOR_MINOR=$RAW" >> $GITHUB_ENV

      - name: Fetch binaries from release/${{ env.MAJOR_MINOR }}
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: release-sisyphos.yml
          name: chainflip-backend-bin-${{ matrix.ubuntu_version }}
          branch: release/${{ env.MAJOR_MINOR }}
          github_token: ${{ secrets.CF_GITHUB_BOT_TOKEN }}
          search_artifacts: true
          check_artifacts: true

      - name: Re-upload binary artifacts
        uses: actions/upload-artifact@v3
        with:
          name: chainflip-backend-bin-${{ matrix.ubuntu_version }}
          path: |
            chainflip-node
            chainflip-engine
            chainflip-cli
            chainflip-broker-api

      - name: Upload binary artifacts
        uses: actions/upload-artifact@v3
        with:
          name: chainflip-node-runtime-${{ matrix.ubuntu_version }}
          path: |
            ./target/release/wbuild/state-chain-runtime/state_chain_runtime*.wasm