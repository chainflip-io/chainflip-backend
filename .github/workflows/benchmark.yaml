name: "Run Benchmarks"
on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: "Which Commit SHA should we get the binaries from?"
        required: true
        type: string
      base_branch_name:
        description: "Which Branch should the Results PR be opened against?"
        required: true
        type: string
      steps:
        description: "How many steps should we run?"
        required: false
        type: string
        default: "20"
      repetitions:
        description: "How many times should we repeat each step?"
        required: false
        type: string
        default: "10"
      benchmark_machine_spec:
        description: "What machine Spec the benchmark will run on?"
        required: true
        default: 4vCPU-8GB
        type: choice
        options:
          - 4vCPU-8GB
          - 4vCPU-16GB

jobs:
  run_benchmarks:
    env:
      CIRCLE_CI_ARTIFACT_URL: ${{ github.event.inputs.circleCiArtifactUrl }}
    runs-on:
      [
        self-hosted,
        linux,
        x64,
        "${{ github.event.inputs.benchmark_machine_spec }}",
      ]
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Tailscale ðŸª¡ âš™ï¸
        id: tailscale
        uses: tailscale/github-action@main
        with:
          authkey: ${{ secrets.CF_TAILSCALE_AUTHKEY }}

      - name: Load secret ðŸ—ðŸ‘¨â€ðŸ’»
        uses: 1password/load-secrets-action@v1
        env:
          OP_CONNECT_HOST: ${{ secrets.CF_1PASSWORD_CONNECTOR_URL }}
          OP_CONNECT_TOKEN: ${{ secrets.CF_1PASSWORD_CONNECTOR_TOKEN_READ_ONLY }}
          CF_APT_REPO_BASIC_AUTH_USERNAME: op://github-actions/CF_APT_REPO_BASIC_AUTH/username
          CF_APT_REPO_BASIC_AUTH_PASSWORD: op://github-actions/CF_APT_REPO_BASIC_AUTH/password

      - name: Download binary to benchmark
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 14DFB4CA9296F83A
          echo "deb https://${{ env.CF_APT_REPO_BASIC_AUTH_USERNAME }}:${{ env.CF_APT_REPO_BASIC_AUTH_PASSWORD }}@apt.aws.chainflip.xyz/ci/${{ inputs.commit_sha }}/ focal main"  | sudo tee /etc/apt/sources.list.d/chainflip.list
          sudo apt update
          sudo apt install chainflip-node

      - name: Run benchmarks
        run: >
          ./state-chain/scripts/benchmark-all.sh
          --binary /usr/bin/chainflip-node
          --steps ${{ github.event.inputs.steps }}
          --repetitions ${{ github.event.inputs.repetitions }}

      - name: Make a pull request with the changed weight files
        uses: peter-evans/create-pull-request@v4
        with:
          base: ${{ inputs.base_branch_name }}
          title: "[AUTOMATED] Benchmark results"
          commit-message: "[AUTOMATED] Benchmarking results."
          body: "This pull request was opened automatically. Close it if you think it was opened in error."
          branch: auto/benchmark-results
          delete-branch: true
          token: ${{ secrets.CF_GITHUB_BOT_TOKEN }}
