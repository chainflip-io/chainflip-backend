name: Post build checks

on:
  workflow_call:
    inputs:
      full_bouncer:
        type: boolean
        default: false
      timeout-minutes:
        type: number
        default: 120
      ngrok:
        type: boolean
        default: false
      node-count:
        type: number
        default: 1

env:
  FORCE_COLOR: 1
  SOLANA_VERSION: v1.18.17
  NODE_COUNT: "${{ inputs.node-count }}-node"

permissions:
  packages: read
  contents: read

jobs:
  bouncer:
    runs-on: digitalocean
    timeout-minutes: ${{ inputs.timeout-minutes }}
    steps:
      - name: Setup ngrok âœ¨
        if: inputs.ngrok
        run: |
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null
          echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list
          sudo apt update
          sudo apt install ngrok

      - name: Checkout chainflip-backend ğŸ›’
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Login to Github Container Registry ğŸ”‘
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to DockerHub ğŸ”‘
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d
        with:
          username: ${{ secrets.CF_DOCKERHUB_USERNAME }}
          password: ${{ secrets.CF_DOCKERHUB_TOKEN }}

      - name: Configure NodeJS ğŸ› ï¸
        uses: actions/setup-node@8f152de45cc393bb48ce5d89d36b731f54556e65
        with:
          node-version: 20
          cache: "pnpm"
          cache-dependency-path: "bouncer/pnpm-lock.yaml"

      - name: Install system packages ğŸ’¿
        run: |
          sudo apt update
          sudo apt install -y bc xxd

      - name: Install wscat ğŸˆ
        run: |
          npm install -g wscat

      - name: Download binaries ğŸ“¥
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: chainflip-backend-bin

      - name: Install node dependencies ğŸ“¦
        working-directory: bouncer
        run: pnpm install

      - name: Install solana â˜€ï¸
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/$SOLANA_VERSION/install)"

      - name: Start a localnet ğŸš€
        env:
          BINARY_ROOT_PATH: .
          DEBUG_OUTPUT_DESTINATION: /tmp/chainflip/debug.log
        run: |
          set -x
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          mkdir -p /tmp/chainflip/bashful
          mkdir -p /tmp/chainflip/doc
          mkdir -p /tmp/chainflip/dopey
          touch /tmp/chainflip/debug.log
          chmod +x ${{ env.BINARY_ROOT_PATH }}/chainflip-*
          chmod +x ${{ env.BINARY_ROOT_PATH }}/engine-runner
          echo "Check for libchainflip_engine_v*.so"
          ls -l /usr/lib/
          # TODO: These shouldn't be required: PRO-1510
          sudo cp ${{ env.BINARY_ROOT_PATH }}/libchainflip_engine_v*.so /usr/lib/
          echo "Check /usr/lib after copy"
          ls -l /usr/lib/
          touch ./localnet/.setup_complete
          ./localnet/manage.sh

      - name: Expose endpoints for Polkadot and Chainflip ğŸ¤¿
        if: inputs.ngrok
        env:
          NGROK_AUTHTOKEN: ${{ secrets.CF_NGROK_AUTHTOKEN }}
        continue-on-error: true
        run: |
          ngrok http http://localhost:9944 --log-format=logfmt --log=/tmp/ngrok-chainflip-node.log &
          ngrok http http://localhost:9945 --log-format=logfmt --log=/tmp/ngrok-polkadot.log &
          sleep 10

      - name: Get ngrok URLs ğŸ”—
        if: inputs.ngrok
        continue-on-error: true
        id: ngrok-urls
        run: python3 ./ci/scripts/get_ngrok_urls.py

      - name: Run HeuteLeiderNicht.voll.exe ğŸ™…â€â™‚ï¸
        if: inputs.full_bouncer
        working-directory: bouncer
        run: |
          ./full_bouncer.sh
          # TODO: Temporary to test the new pallet. Improve in PRO-1599
          ./tests/delta_based_ingress.ts prebuilt --bins ./../ --localnet_init ./../localnet/init

      - name: Run HeuteLeiderNicht.einfach.exe ğŸ¦º
        if: ${{ ! inputs.full_bouncer }}
        working-directory: bouncer
        run: |
          ./run.sh

      - name: Write chain explorer to file ğŸ“
        if: failure()
        continue-on-error: true
        working-directory: bouncer
        run: |
          BLOCK_HEIGHT=$(curl -s -H "Content-Type: application/json" \
          -d '{"jsonrpc":"2.0","method":"chain_getHeader","params":[],"id":1}' \
          http://localhost:9944 \
          | jq -r '.result.number' \
          | xargs printf "%d\n")
          ./commands/explorer.ts 0 $BLOCK_HEIGHT > /tmp/chainflip/explorer.txt

      - name: Upload chain explorer ğŸ“¤
        if: failure()
        continue-on-error: true
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874
        with:
          name: chain-explorer
          path: /tmp/chainflip/explorer.txt

      - name: Print chainflip-engine logs ğŸš—
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/chainflip/*/chainflip-engine.*log

      - name: Print chainflip-node logs ğŸ“¡
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/chainflip/*/chainflip-node.*log

      - name: Print chainflip-broker-api logs ğŸ’¼
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/chainflip/chainflip-broker-api.*log

      - name: Print chainflip-lp-api logs ğŸ¤‘
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/chainflip/chainflip-lp-api.*log

      - name: Print localnet init debug logs ğŸ•µï¸â€â™‚ï¸
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/chainflip/debug.log

      - name: Print solana logs â˜€ï¸
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/solana/*.log
          cat /tmp/solana/test-ledger/validator.log

      - name: Upload Localnet Logs ğŸ’¾
        if: always()
        continue-on-error: true
        uses: actions/upload-artifact@50769540e7f4bd5e21e526ee35c689e35e0d6874
        with:
          name: localnet-logs
          path: |
            /tmp/chainflip/*/chainflip-*.*log
            /tmp/chainflip/chainflip-*.*log
            /tmp/chainflip/debug.*log
            /tmp/solana/*.*log

      - name: List /tmp/chainflip ğŸ“‚
        if: always()
        continue-on-error: true
        run: ls -alR /tmp/chainflip

      - name: List /tmp/solana ğŸ“‚
        if: always()
        continue-on-error: true
        run: ls -alR /tmp/solana

      - name: Show logs from docker containers ğŸ³ğŸ•µï¸â€â™‚ï¸
        if: always()
        continue-on-error: true
        run: docker compose -f localnet/docker-compose.yml -p "chainflip-localnet" logs

      - name: Clean Up docker containers ğŸ§¹
        if: always()
        continue-on-error: true
        run: |
          docker compose -f localnet/docker-compose.yml -p "chainflip-localnet" down --volumes --remove-orphans

      - name: Notify on failed bouncer ğŸ“¢
        if: failure() && github.ref_name == 'main' || cancelled() && github.ref_name == 'main' || failure() && contains(github.ref_name, 'release/') || cancelled() && contains(github.ref_name, 'release/')
        env:
          DISCORD_USERNAME: "HEUTE LEIDER NICHT"
          DISCORD_WEBHOOK: ${{ secrets.CF_DISCORD_ALERTS_CRITICAL }}
        uses: Ilshidur/action-discord@0c4b27844ba47cb1c7bee539c8eead5284ce9fa9
        with:
          args: |
            â—ï¸â—ï¸â—ï¸â—ï¸ Sorry **${{ github.actor }}**, the Bouncer has rejected you â—ï¸â—ï¸â—ï¸â—ï¸
            The Bouncer has rejected the build on branch `${{ github.ref_name }}`
            ğŸ‘¾ Link to job: <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}>

  chainspec-compatibility:
    runs-on: namespace-profile-default
    strategy:
      fail-fast: false
      matrix:
        network: [sisyphos, perseverance, berghain]
    steps:
      - name: Checkout chainflip-backend ğŸ›’
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11

      - name: Download Binaries ğŸ“¥
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: chainflip-backend-bin

      - name: Make Binaries Executable ğŸ› ï¸
        run: |
          chmod +x chainflip-*

      - name: Run Test ğŸ§ª
        shell: bash
        run: ./ci/scripts/check_node_syncing.sh --network ${{ matrix.network }} --binary-root-path .

      - name: Print logs ğŸ“œ
        if: always()
        continue-on-error: true
        run: |
          cat /tmp/chainflip-node.log
