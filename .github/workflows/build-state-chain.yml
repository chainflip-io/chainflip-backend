name: Check then build

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the master branch
  push:
    branches: [ master ]
    # Only trigger this if files in these directories change.
    paths:
    - 'state-chain/**'
    - 'common/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  check:
    # The type of runner that the job will run on
    runs-on: ubuntu-20.04

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - uses: actions/checkout@v2
      with:
        token: ${{ secrets.CI_PAT }} # CI_PAT is a secret that contains a personal access token for checking out private repos
        
    - uses: actions/cache@v2
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Set-Up
      run: sudo apt install -y cmake pkg-config libssl-dev git build-essential clang libclang-dev curl

    - name: Install Rustup
      run: |
        curl https://sh.rustup.rs -sSf | sh -s -- -y
        source ~/.cargo/env
        rustup default stable
        
    - name: Build
      run: |
        make -C state-chain init
        make -C state-chain build

    - name: Upload artifacts
      uses: actions/upload-artifact@v1
      with:
        name: State chain
        path: target/release/state-chain-node
