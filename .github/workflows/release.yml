name: Release Chainflip
on:
  push:
    branches:
      - 'release/*'
      - chore/ci-refactor
    tags:
      - 'v*'

env:
  SCCACHE_CACHE_SIZE: 32G
  SCCACHE_VERSION: v0.4.1
  SCCACHE_REDIS: ${{ secrets.SCCACHE_REDIS }}
  CF_RUNNER_SUDO_PASSWORD: ${{ secrets.CF_RUNNER_SUDO_PASSWORD }}

jobs:
  init:
    uses: ./.github/workflows/_00_init.yml
#  check:
#    uses: ./.github/workflows/_01_check.yml
  test:
#    needs: [check]
    uses: ./.github/workflows/_10_test.yml
  build:
    needs: [test]
    uses: ./.github/workflows/_20_build.yml
  release-sisyphos:
    name: Publish Packages to APT repo
    needs: [build]
    uses: ./.github/workflows/_30_publish.yml
    with:
      artifacts: chainflip-backend-packages-dev
      version: "sisyphos/"
      environment: dev
      commit_hash: ${{ needs.set-variables.outputs.commit_hash }}
    secrets: inherit
  release-perseverance:
    name: Publish Packages to APT repo
    if: github.ref_type == 'tag'
    needs: [build]
    uses: ./.github/workflows/_30_publish.yml
    with:
      artifacts: chainflip-backend-packages-prod
      version: "perseverance/"
      environment: prod
      commit_hash: ${{ needs.set-variables.outputs.commit_hash }}
    secrets: inherit