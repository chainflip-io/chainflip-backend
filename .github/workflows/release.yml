name: Release Chainflip
on:
  push:
    branches:
      - 'release/*'
      - chore/ci-refactor
    tags:
      - 'v*'

jobs:
  init:
    uses: ./.github/workflows/_00_init.yml
#  pre-check:
#    uses: ./.github/workflows/_01_pre_check.yml
#  test:
#    needs: [check]
#    uses: ./.github/workflows/_10_test.yml
#    secrets: inherit
  build:
#    needs: [test]
    uses: ./.github/workflows/_20_build.yml
    secrets: inherit
  post-check:
    needs: [build]
    uses: ./.github/workflows/_25_post_check.yml
    secrets: inherit
  release-sisyphos:
    name: Publish Packages to APT repo
    needs: [post-check]
#    needs: [build]
    uses: ./.github/workflows/_30_publish.yml
    with:
      artifacts: chainflip-backend-packages-sisyphos
      version: "sisyphos/"
      environment: dev
      commit_hash: ${{ needs.set-variables.outputs.commit_hash }}
    secrets: inherit
  release-perseverance:
    name: Publish Packages to APT repo
    if: github.ref_type == 'tag'
    needs: [post-check]
#    needs: [build]
    uses: ./.github/workflows/_30_publish.yml
    with:
      artifacts: chainflip-backend-packages-perseverance
      version: "perseverance/"
      environment: prod
      commit_hash: ${{ needs.set-variables.outputs.commit_hash }}
    secrets: inherit