name: Publish Helm Chart 📚

on:
  push:
    # branches:
    #   - main
    # paths:
    #   - charts/**
env:
  FORCE_COLOR: 1

jobs:
  release:
    name: Test and releasing Helm Charts
    runs-on: ubuntu-latest
    strategy:
      matrix:
        chart: [chainflip-broker-api]
    steps:
      - name: Checkout 🏁
        uses: actions/checkout@v3

      - name: Setup helmfile 🎮
        uses: mamezou-tech/setup-helmfile@v1.0.0
        with:
          helmfile-version: 'v0.144.0'
          helm-version: 'v3.9.0'

      - name: Update Dependencies 🦾
        run: helm dependency update charts/${{ matrix.chart }}

      - name: Helm Lint ✍️
        run: helm lint charts/${{ matrix.chart }}

      - name: Package charts 📦
        run: helm package charts/${{ matrix.chart }}

      - name: Login to registry  🔑
        run: helm registry login ghcr.io --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }}

      - name: Push charts to GitHub registry 🐙
        run: |
          VERSION=$(yq '.version' charts/${{ matrix.chart }}/Chart.yaml)
          helm push ${{ matrix.chart }}-$VERSION.tgz oci://ghcr.io/chainflip-io/charts
